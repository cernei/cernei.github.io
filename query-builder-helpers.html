<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/php.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" title="Idea" href="https://highlightjs.org/static/demo/styles/idea.css">
    <style>
        td {
            vertical-align: top;
        }
        code {
            border: 1px solid #CCC;
            padding: 10px;
        }
    </style>
</head>
<body>
<ul>
    <li>Reduce amount of code, make it more easy ro read</li>
    <li>Make unification of doctrine and elastic</li>
</ul>
<h3>andWhere()</h3>
<pre><code class="php">$this-&gt;param('postedfrom')-&gt;andWhere('posted_date', '&gt;=');</code></pre>
<h3>instead of:</h3>
<table>
    <tr>
        <td>
                <pre><code class="php">//doctrine
if (isset($filter['postedfrom'])) {
    $this-&gt;queryBuilder-&gt;andWhere($this-&gt;queryBuilder-&gt;expr()-&gt;gte(
        $this-&gt;searchAlias . '.posted_date',
        ':postedfrom'
    ))-&gt;setParameter('postedfrom', $filter['postedfrom']);
}</code></pre>
        </td>
        <td>
                <pre><code class="php">// elastic
if (isset($filter['postedfrom'])) {
    $queryDSL-&gt;addFilter(
        $this-&gt;queryBuilder-&gt;query()-&gt;range(
            'postedDate',
            array('gte' =&gt; $filter['postedfrom'])
        )
    );
}</code></pre>

        </td>
    </tr>
</table>
<h3>andWhere(..., 'in')</h3>
<pre><code class="php">$this-&gt;param('statuses')-&gt;addLeftJoin('status', 'tender_status')-&gt;andWhere('tender_status', 'in');</code></pre>
<h3>instead of:</h3>
<table>
    <tr>
        <td>
                <pre><code class="php">//doctrine
if (isset($filter['statuses'])) {
    $this-&gt;queryBuilder-&gt;addLeftJoin($this-&gt;searchAlias . '.status', 'tender_status');
    $this-&gt;queryBuilder-&gt;andWhere($this-&gt;queryBuilder-&gt;expr()-&gt;in('tender_status', $filter['statuses']));
}</code></pre>
        </td>
        <td>
                <pre><code class="php">//elastic
if (isset($filter['statuses'])) {
    $statusQuery = $this-&gt;queryBuilder-&gt;query()-&gt;bool();
    $statusQuery-&gt;addShould(
        $this-&gt;queryBuilder-&gt;query()-&gt;terms('statusId', (array)$filter['statuses'])
    );
    $statusQuery-&gt;setMinimumNumberShouldMatch(1);
    $queryDSL-&gt;addFilter($statusQuery);
}</code></pre>

        </td>
    </tr>
</table>
<h3>andWhereOr()</h3>
<pre><code class="php">$this-&gt;param('modifiedOrPostedAfter')-&gt;andWhereOr([
    ['posted_date', '&gt;'],
    ['last_modified_date', '&gt;'],
]);</code></pre>
<h3>instead of:</h3>
<table>
    <tr>
        <td>
                <pre><code class="php">//doctrine
if (isset($filter['modifiedOrPostedAfter'])) {
    $this-&gt;queryBuilder-&gt;andWhere($this-&gt;queryBuilder-&gt;expr()-&gt;orX(
        $this-&gt;queryBuilder-&gt;expr()-&gt;gt($this-&gt;searchAlias . '.last_modified_date', ':modifiedOrPostedAfter'),
        $this-&gt;queryBuilder-&gt;expr()-&gt;gt($this-&gt;searchAlias . '.posted_date', ':modifiedOrPostedAfter')
    ))-&gt;setParameter('modifiedOrPostedAfter', $filter['modifiedOrPostedAfter']);
}
</code></pre>
        </td>
        <td>
                <pre><code class="php">//elastic
if (isset($filter['modifiedOrPostedAfter'])) {
    $modifiedPostedAfterQuery = $this-&gt;queryBuilder-&gt;query()-&gt;bool();
    $modifiedPostedAfterQuery-&gt;addShould(
        $this-&gt;queryBuilder-&gt;query()-&gt;range(
            'lastModifiedDate',
            array('gt' =&gt; $filter['modifiedOrPostedAfter'])
        )
    );
    $modifiedPostedAfterQuery-&gt;addShould(
        $this-&gt;queryBuilder-&gt;query()-&gt;range(
            'postedDate',
            array('gt' =&gt; $filter['modifiedOrPostedAfter'])
        )
    );
    $modifiedPostedAfterQuery-&gt;setMinimumNumberShouldMatch(1);
    $queryDSL-&gt;addFilter($modifiedPostedAfterQuery);
}</code></pre>

        </td>
    </tr>
</table>
<h3>boolToNullCheck()</h3>
<pre><code class="php">$this-&gt;param('has_avatar')-&gt;boolToNullCheck('avatarFileName');
</code></pre>
<h3>instead of:</h3>
<table>
    <tr>
        <td>
                <pre><code class="php">//doctrine
if (isset($filter['has_avatar'])) {
    $this-&gt;queryBuilder
        -&gt;andWhere(
            $filter['has_avatar']
                ? $this-&gt;queryBuilder-&gt;expr()-&gt;isNotNull($this-&gt;searchAlias . '.avatarFileName')
                : $this-&gt;queryBuilder-&gt;expr()-&gt;isNull($this-&gt;searchAlias . '.avatarFileName')
        );
}</code></pre>
        </td>
        <td>
                <pre><code class="php">//elastic
if (isset($filter['has_avatar'])) {
    $hasAvatarQuery = $queryBuilder-&gt;query()-&gt;bool();
    $hasAvatarQuery-&gt;addMust(
        $queryBuilder-&gt;query()-&gt;term(['hasAvatar' =&gt; (bool)$filter['has_avatar']])
    );
    $queryDSL-&gt;addFilter($hasAvatarQuery);
}</code></pre>

        </td>
    </tr>
</table>
<h3>andWhereInWithSpecialWordForNull()</h3>
<pre><code class="php">$this-&gt;param('contractingAuthorityTypes')
    -&gt;addLeftJoin('contractingAuthorityTypes', 'tenderContractingAuthorityTypes')
    -&gt;andWhereInWithSpecialWordForNull('tenderContractingAuthorityTypes', 'unknown');</code></pre>
<h3>instead of:</h3>
<table>
    <tr>
        <td>
                <pre><code class="php">//doctrine
if (isset($filter['contractingAuthorityTypes'])) {
    $this-&gt;queryBuilder-&gt;addLeftJoin(
        $this-&gt;searchAlias . '.contractingAuthorityTypes',
        'tenderContractingAuthorityTypes'
    );

    $contractingAuthorityTypesFilters = $this-&gt;queryBuilder-&gt;expr()-&gt;orX();
    // noContractingAuthorityTypes
    if (\in_array('unknown', $filter['contractingAuthorityTypes'], true)) {
        $filter['contractingAuthorityTypes'] = array_diff($filter['contractingAuthorityTypes'], ['unknown']);
        $contractingAuthorityTypesFilters-&gt;add(
            $this-&gt;queryBuilder-&gt;expr()-&gt;isNull('tenderContractingAuthorityTypes')
        );
    }
    // contractingAuthorityTypesIn
    if (!empty($filter['contractingAuthorityTypes'])) {
        $contractingAuthorityTypesFilters-&gt;add(
            $this-&gt;queryBuilder-&gt;expr()-&gt;in(
                'tenderContractingAuthorityTypes',
                $filter['contractingAuthorityTypes']
            )
        );
    }

    $this-&gt;queryBuilder-&gt;andWhere($contractingAuthorityTypesFilters);
}</code></pre>
        </td>
        <td>
                <pre><code class="php">// elastic
if (isset($filter['contractingAuthorityTypes']) &amp;&amp; \is_array($filter['contractingAuthorityTypes'])) {
    $contractingAuthorityTypesQuery = $this-&gt;queryBuilder-&gt;query()-&gt;bool();
    // noContractingAuthorityTypes
    if (\in_array('unknown', $filter['contractingAuthorityTypes'], true)) {
        $filter['contractingAuthorityTypes'] = array_diff($filter['contractingAuthorityTypes'], ['unknown']);
        $contractingAuthorityTypesQuery-&gt;addShould(
            $this-&gt;queryBuilder-&gt;query()-&gt;constant_score(
                [
                    'missing' =&gt; ['field' =&gt; 'contractingAuthorityTypeIds'],
                ]
            )
        );
    }
    // ContractingAuthorityTypesIn
    if (!empty($filter['contractingAuthorityTypes'])) {
        $contractingAuthorityTypesQuery-&gt;addShould(
            $this-&gt;queryBuilder-&gt;query()-&gt;terms(
                'contractingAuthorityTypeIds',
                $filter['contractingAuthorityTypes']
            )
        );
    }
    $contractingAuthorityTypesQuery-&gt;setMinimumNumberShouldMatch(1);
    $queryDSL-&gt;addFilter($contractingAuthorityTypesQuery);
}</code></pre>

        </td>
    </tr>
</table>
<h3>andWhereAnd</h3>
<pre><code class="php">$this-&gt;andWhereAnd([
    ['expertAssociatedMember.active','=','TRUE'],
    ['expertAssociatedMember.expired','=','FALSE'],
    ['expertAssociatedMember.expiration_date' , '&gt;=', 'CURRENT_DATE()'],
    ['IDENTITY(expertAssociatedMember.membership)', 'in',
        $this-&gt;fundingAlertActivationManipulator-&gt;getExpertMembershipPackagesWithFundingAlert()]
]);</code></pre>
<h3>instead of:</h3>
<table>
    <tr>
        <td>
                <pre><code class="php">//doctrine
$this-&gt;queryBuilder-&gt;andWhere($this-&gt;queryBuilder-&gt;expr()-&gt;eq('expertAssociatedMember.active', 'TRUE'));
$this-&gt;queryBuilder-&gt;andWhere($this-&gt;queryBuilder-&gt;expr()-&gt;eq('expertAssociatedMember.expired', 'FALSE'));
$this-&gt;queryBuilder-&gt;andWhere(
    $this-&gt;queryBuilder-&gt;expr()-&gt;gte('expertAssociatedMember.expiration_date', 'CURRENT_DATE()')
);
$this-&gt;queryBuilder-&gt;andWhere(
    $this-&gt;queryBuilder-&gt;expr()-&gt;in(
        'IDENTITY(expertAssociatedMember.membership)',
        $this-&gt;fundingAlertActivationManipulator-&gt;getExpertMembershipPackagesWithFundingAlert()
    )
);</code></pre>
        </td>
        <td>
                <pre><code class="php">//elastic
</code></pre>

        </td>
    </tr>
</table>
<h3>Example of transformation</h3>

</body>
</html>